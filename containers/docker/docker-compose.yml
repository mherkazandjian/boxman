services:
  boxman-libvirt:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: boxman-libvirt
    privileged: true
    restart: unless-stopped

    # expose libvirt tcp socket and qemu guest agent socket
    ports:
      - "127.0.0.1:16509:16509"   # libvirtd plain TCP
      - "127.0.0.1:16514:16514"   # libvirtd TLS

    # devices required for nested virtualization
    devices:
      - /dev/kvm:/dev/kvm
      - /dev/net/tun:/dev/net/tun
      - /dev/vhost-net:/dev/vhost-net
      - /dev/vhost-vsock:/dev/vhost-vsock

    # mount host paths needed for libvirt operation
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      - /lib/modules:/lib/modules:ro
      - boxman-images:/var/lib/libvirt/images
      - /var/lib/boxman/libvirt-run:/var/run/libvirt
      # Mount host passwd/group so libvirtd can resolve any host UID connecting via the socket
      - /etc/passwd:/etc/passwd:ro
      - /etc/group:/etc/group:ro

    # required capabilities for networking and virtualization
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_ADMIN
      - SYS_PTRACE
      - DAC_READ_SEARCH
      - MKNOD
      - AUDIT_WRITE
      - SYS_MODULE

    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined

    environment:
      - LIBVIRT_DEFAULT_URI=qemu:///system
      - HOST_UID=${HOST_UID:-1000}
      - HOST_GID=${HOST_GID:-1000}

    # ──────────────────────────────────────────────────────────────
    # HARDENING GUIDELINES (for production / shared environments):
    #
    # 1. Remove `privileged: true` and use only the specific
    #    cap_add entries listed above.
    #
    # 2. Re-enable libvirt socket authentication:
    #      auth_unix_rw = "polkit"  (or "sasl")
    #    and remove the 0777 socket permissions.
    #
    # 3. Restrict socket bind-mount permissions:
    #      chmod 0770 /var/lib/boxman/libvirt-run
    #      chown root:<your-group> /var/lib/boxman/libvirt-run
    #    and add your dev user to that group.
    #
    # 4. Use read-only root filesystem where possible:
    #      read_only: true  (with explicit tmpfs/volume mounts)
    #
    # 5. Drop seccomp:unconfined / apparmor:unconfined and use
    #    a custom seccomp profile that allows only needed syscalls.
    #
    # 6. Limit container resources:
    #      deploy:
    #        resources:
    #          limits:
    #            cpus: '4'
    #            memory: 8G
    #
    # 7. Use TLS for remote libvirt connections (port 16514)
    #    instead of plain TCP (port 16509).
    #
    # 8. Run libvirtd as a non-root user inside the container
    #    where feasible.
    # ──────────────────────────────────────────────────────────────

volumes:
  boxman-images:
  boxman-libvirt-run:
